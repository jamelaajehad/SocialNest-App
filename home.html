<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialNest</title>
    <link rel="stylesheet" href="style.css"> 
     <!-- IMPORT SCRIPTS & STYLES -->
    <script src="./node_modules/axios/dist/axios.min.js"> </script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"> </script>
    <link rel="stylesheet" href="./node_modules/bootstrap/dist/css/bootstrap.min.css"> 
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nerko+One&family=Outfit:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
   
</head>
<style>
  body {
    background-color:  #eeeaea;
    font-family: "Outfit", sans-serif;
  }
  
</style>
<body>
  

  <div class="add-btn1" id="add-btn" data-bs-toggle="modal" data-bs-target="#create-post-modal">
   +
  </div>

  <div class="modal fade" id="create-post-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">Create A New Post</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="mb-3">
              <label for="recipient-name" class="col-form-label">Title:</label>
              <input type="text" class="form-control" id="post-title-input">
            </div>
            <div class="mb-3">
            <textarea name="" id="post-body-input" style="width: 100%; height: 100px; border-color: grey; border-radius: 10px; resize: none;">

            </textarea>
            <div class="mb-3">
              <label for="recipient-name" class="col-form-label">Image:</label>
              <input type="file" class="form-control" id="post-image-input">
            </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="close-btn" data-bs-dismiss="modal">Close</button>
          <button type="button" class="create-btn" onclick="createNewPostClick()">Create</button>
        </div>
      </div>
    </div>
  </div>
  <!-- NAVBAR CONT -->
    <div class="container">
        <div class="d-flex justify-content-center">
          <div class="col-8
          "> 
             <nav class="navbar navbar-expand-lg bg-white shadow rounded pt-3 px-3">
            <div class="container-fluid">
             <a class="navbar-brand" href="#">SocialNest </a>
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                  <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="#">Home</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">Profile</a>
                  </li>
                </ul>
                <div class="d-flex w-100 justify-content-end" id="logged-in-div" > 
                    <button type="button" id="login-btn" class="login-btn" onclick="redirectToLogin() " >Login</button>
                    <button type="button" id= "register-btn" class="register-btn" onclick="redirectToregister() ">Register</button>
                </div>
                <div class="d-flex w-100 justify-content-end align-items-center"  id="logout-div" > 
                  <img id= "nav-image" src="./images/1.png" alt="" class="rounded-circle" style ="width:30px; height: 30px;">
                  <b id="nav-username" style="font-weight: 300;">
                    @omarrr
                  </b>
                  <button type="button" onclick="logout()" id= "logout-btn" class="logout-btn">Logout</button>
                </div>
              </div>
            </div>
             </nav>
          </div>
        </div>
    </div>
 <!-- //NAVBAR CONT // -->
    <!--MAIN CONTENT -->
    <div class="container " style="height: 1000px;">
        <!-- POSTS -->
        <div class="d-flex justify-content-center mt-5">
            <div class="col-8"> 
               <div id="posts">
            <!-- POST -->
            <div class="card shadow " style="border-color: rgb(248, 186, 144);">
                <div class="card-header" style="background-color: rgb(255, 255, 255) ;">
                  <img class="rounded-circle " src="./images/1.png" alt="" style="width: 40px; height: 40px; border: 2px solid rgb(204, 113, 60) ;"> 
                  <span>@mohmd</span>
                </div>
                <div class="card-body">
                  <img  src="./placeholders/sky.jpg" alt=""  style="width: 100%; height: 400px;"  >
                  <h6 style="color: rgb(156, 154, 154) ;" class="mt-1" > 2 min ago</h6>
                  <h5> Hello World</h5>
                  <p> Lorem ipsum dolor sit amet consectetur adipisicing elit. Atque, ipsam facere et nostrum veniam ipsa sunt dolores recusandae magnam sed provident asperiores aspernatur reprehenderit culpa unde nemo necessitatibus exercitationem corporis!</p>
                  <hr>
                  <div> 
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-chat" viewBox="0 0 16 16">
                      <path d="M2.678 11.894a1 1 0 0 1 .287.801 11 11 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8 8 0 0 0 8 14c3.996 0 7-2.807 7-6s-3.004-6-7-6-7 2.808-7 6c0 1.468.617 2.83 1.678 3.894m-.493 3.905a22 22 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a10 10 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9 9 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105"/>
                    </svg>
                    <span>
                      (3) Comments
                    </span>
                  </div>
                </div>
              </div>
              <!-- //POST// -->
              <div class="card shadow " style="border-color: rgb(248, 186, 144);">
                <div class="card-header" style="background-color: rgb(255, 255, 255) ;">
                  <img class="rounded-circle " src="./images/1.png" alt="" style="width: 40px; height: 40px; border: 2px solid rgb(204, 113, 60) ;"> 
                  <span>@mohmd</span>
                </div>
                <div class="card-body">
                  <img  src="./placeholders/sky.jpg" alt=""  style="width: 100%; height: 400px;"  >
                  <h6 style="color: rgb(156, 154, 154) ;" class="mt-1" > 2 min ago</h6>
                  <h5> Hello World</h5>
                  <p> Lorem ipsum dolor sit amet consectetur adipisicing elit. Atque, ipsam facere et nostrum veniam ipsa sunt dolores recusandae magnam sed provident asperiores aspernatur reprehenderit culpa unde nemo necessitatibus exercitationem corporis!</p>
                  <hr>
                  <div> 
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-chat" viewBox="0 0 16 16">
                      <path d="M2.678 11.894a1 1 0 0 1 .287.801 11 11 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8 8 0 0 0 8 14c3.996 0 7-2.807 7-6s-3.004-6-7-6-7 2.808-7 6c0 1.468.617 2.83 1.678 3.894m-.493 3.905a22 22 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a10 10 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9 9 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105"/>
                    </svg>
                    <span>
                      (3) Comments
                    </span>
                  </div>
                </div>
              </div>
              <!-- POST -->
            <div class="card shadow" style="border-color:  rgb(248, 186, 144);">
              <div class="card-header" style="background-color: rgb(255, 254, 254) ;">
                <img class="rounded-circle " src="./images/1.png" alt="" style="width: 40px; height: 40px; border: 2px solid rgb(204, 113, 60) ;"> 
                <span>@mohmd</span>
              </div>
              <div class="card-body">
                <img  src="./placeholders/sky.jpg" alt=""  style="width: 100%; height: 400px;"  >
                <h6 style="color: rgb(156, 154, 154) ;" class="mt-1" > 2 min ago</h6>
                <h5> Hello World</h5>
                <p> Lorem ipsum dolor sit amet consectetur adipisicing elit. Atque, ipsam facere et nostrum veniam ipsa sunt dolores recusandae magnam sed provident asperiores aspernatur reprehenderit culpa unde nemo necessitatibus exercitationem corporis!</p>
                <hr>
                <div> 
                  <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-chat" viewBox="0 0 16 16">
                    <path d="M2.678 11.894a1 1 0 0 1 .287.801 11 11 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8 8 0 0 0 8 14c3.996 0 7-2.807 7-6s-3.004-6-7-6-7 2.808-7 6c0 1.468.617 2.83 1.678 3.894m-.493 3.905a22 22 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a10 10 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9 9 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105"/>
                  </svg>
                  <span>
                    (3) Comments
                  </span>
                </div>
              </div>
            </div>
            <!-- //POST// -->
               </div>
            </div>
        </div>
    </div> 
</body>
<script>
  
  let currentPage = 1
  let lastPage = 1 
   window.addEventListener("scroll",function(){
     const endOfPage = window.innerHeight + window.pageYOffset >= document.body.offsetHeight;
      if(endOfPage && currentPage < lastPage) 
      {
        currentPage= currentPage + 1 
         getPosts(false,currentPage)
      }
}
);
  setupUI ()
  getPosts()
  const baseUrl ="https://tarmeezacademy.com/api/v1"

  function getPosts(reload = true ,page=1) {
     const baseUrl ="https://tarmeezacademy.com/api/v1"
     axios.get(`${baseUrl}/posts?limit&page=${page}`)
     .then((response)=> {
     const posts = response.data.data
     lastPage = response.data.meta.last_page
     if(reload){
      document.getElementById("posts").innerHTML= "";
     }
   
     for(post of posts)
     {
      console.log(post)

      const author = post.author;
      let postTitle = "";

      if(post.title !=null)
     {
         postTitle=post.title;
     }

      let content = `<div class="card shadow " style="border-color: rgb(248, 186, 144)  ;">
                <div class="card-header" style="background-color:  rgb(255, 254, 254) ;">
                  <img class="rounded-circle " src="${author.profile_image}" alt="" style="width: 40px; height: 40px; border: 2px solid  rgb(199, 95, 35) ;"> 
                  <span>${author.username}</span>
                </div>
                <div class="card-body">
                  <img  src="${post.image}" alt=""  style="width: 100%; height: 400px;"  >
                  <h6 style="color: rgb(156, 154, 154) ;" class="mt-1" > ${post.created_at}</h6>
                  <h5>${postTitle}</h5>
                  <p> ${post.body}</p>
                  <hr>
                  <div> 
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-chat" viewBox="0 0 16 16">
                      <path d="M2.678 11.894a1 1 0 0 1 .287.801 11 11 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8 8 0 0 0 8 14c3.996 0 7-2.807 7-6s-3.004-6-7-6-7 2.808-7 6c0 1.468.617 2.83 1.678 3.894m-.493 3.905a22 22 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a10 10 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9 9 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105"/>
                    </svg>
                    <span>
                      ${post.comments_count} Comments 
                       <span id= "post-tags-${post.id}">
                        <button class="btn-tag"> policy</button>
                        <button class="btn-tag"> policy</button>
                        <button class="btn-tag"> policy</button>
                        </span>
                    </span>
                  </div>
                </div>
              </div>
      `
      document.getElementById("posts").innerHTML += content
      const currentPostTagsId = `post-tags-${post.id}`

      document.getElementById(currentPostTagsId).innerHTML = "";
      
      for(tag of post.tags)
      {
        console.log(tag.name)
        let tagsContent=
        ` 
         <button class="btn-tag"> ${tag.name}</button>
        `
        document.getElementById(currentPostTagsId).innerHTML += tagsContent
      }
     }
  } )
  }
 
  function redirectToLogin() {
    window.location.href = "login.html";  
}

function redirectToregister() {
    window.location.href = "register.html";  
}


  
  function createNewPostClick(){
     const title = document.getElementById("post-title-input").value;
     const body= document.getElementById("post-body-input").value;
     const image= document.getElementById("post-image-input").files[0] ;

     let formData = new FormData()
     formData.append("body" , body) 
     formData.append("title" , title) 
     formData.append("image" , image) 
     
     const url = `${baseUrl}/posts`

     const token = localStorage.getItem("token")
     if (!token) {
      console.error("No token found in localStorage"); 
     }
     const headers ={
      "Content-Type" : "multipart/form-data" ,
      "Authorization" : `Bearer ${token}`
     }
     axios.post(url, formData , {
      headers:headers
     })
      .then((response) => {
        const modal = document.getElementById("create-post-modal")
        const modalInstance = bootstrap.Modal.getInstance(modal)
        modalInstance.hide()
        Toastify({
          text: "New Post Has Been Created!" ,
          duration: 3000,  
          gravity: "top", 
          position: "right", 
          style: {
            background: " rgb(94, 173, 130) ",
            border: "2px solid rgb(94, 173, 130) ", 
            color: "white", 
            borderRadius: "5px", 
            padding: "10px", 
  },
        }).showToast();
        getPosts()
       
      })

      .catch((error) => {
      const message = error.response.data.message
      Toastify({
      text:message ,
      duration: 3000, 
      gravity: "top", 
      position: "right", 
      style: {
       background: " rgb(255, 77, 77)",
       border: "2px solid rgb(255, 77, 77) ", 
       color: "white", 
       borderRadius: "5px", 
       padding: "10px", 
  },
    }).showToast();

      }
    ) 
    
      
    }



  function logout() {
    localStorage.removeItem("token") 
    localStorage.removeItem("user")

    Toastify({
      text:" You have successfully logged out." ,
      duration: 3000, 
      gravity: "top", 
      position: "right", 
      style: {
       background: " rgb(197, 107, 56) ",
       border: "2px solid rgb(197, 107, 56) ", 
       color: "white", 
       borderRadius: "5px", 
       padding: "10px", 
  },
    }).showToast();



    setupUI ()
  }


     function setupUI ()
      {
        const token = localStorage.getItem("token")
        const loginDiv = document.getElementById("logged-in-div")
        const logoutDiv = document.getElementById("logout-div")
        
        const addBtn = document.getElementById("add-btn")

        if (token== null)
      {
          addBtn.style.setProperty("display","none","important")
          loginDiv.style.setProperty("display","flex","important")
          logoutDiv.style.setProperty("display" , "none" ,"important")   
      }else {
        addBtn.style.setProperty("display","block","important")
        loginDiv.style.setProperty("display","none","important")
        logoutDiv.style.setProperty("display" , "flex" ,"important")

        const user = getCurrentUser()
        document.getElementById("nav-username").innerHTML= user.username
        document.getElementById("nav-image").src = user.profile_image
      }
     }

     function getCurrentUser() {
      let user = null
      const storageUser = localStorage.getItem("user")
      if(storageUser != null) {
        user = JSON.parse(storageUser)
      }
      return user
     }

</script>
</html>